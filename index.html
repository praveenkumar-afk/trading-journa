<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal Dashboard</title>
    <style>
        :root {
            --color-background: #1a1d1f;
            --color-surface: #252829;
            --color-surface-hover: #2d3234;
            --color-text: #f5f5f5;
            --color-text-secondary: #a7a9a9;
            --color-primary: #32b8c6;
            --color-primary-hover: #2da4b2;
            --color-success: #32b8c6;
            --color-error: #ff5459;
            --color-warning: #e68161;
            --color-border: rgba(119, 124, 124, 0.3);
            --color-card-border: rgba(119, 124, 124, 0.2);
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --radius-base: 8px;
            --radius-lg: 12px;
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-24: 24px;
            --space-32: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: var(--color-surface);
            padding: var(--space-24);
            border-right: 1px solid var(--color-border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            margin-bottom: var(--space-32);
            font-size: 20px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: var(--space-8);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-12);
            border-radius: var(--radius-base);
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: var(--color-surface-hover);
            color: var(--color-text);
        }

        .nav-link.active {
            background: var(--color-primary);
            color: var(--color-background);
        }

        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: var(--space-32);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-32);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .btn {
            padding: var(--space-12) var(--space-24);
            border-radius: var(--radius-base);
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-family-base);
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-background);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-surface-hover);
        }

        .btn-small {
            padding: var(--space-8) var(--space-16);
            font-size: 13px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-32);
        }

        .metric-card {
            background: var(--color-surface);
            padding: var(--space-24);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
        }

        .metric-label {
            color: var(--color-text-secondary);
            font-size: 13px;
            margin-bottom: var(--space-8);
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
        }

        .metric-change {
            font-size: 13px;
            margin-top: var(--space-8);
        }

        .positive {
            color: var(--color-success);
        }

        .negative {
            color: var(--color-error);
        }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-24);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            padding: var(--space-12);
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            color: var(--color-text);
            font-size: 14px;
            font-family: var(--font-family-base);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: var(--space-12);
            background: var(--color-background);
            color: var(--color-text-secondary);
            font-weight: 500;
            font-size: 13px;
            border-bottom: 1px solid var(--color-border);
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: var(--color-surface-hover);
        }

        th .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.3;
            font-size: 10px;
        }

        th.sorted .sort-icon {
            opacity: 1;
        }

        td {
            padding: var(--space-12);
            border-bottom: 1px solid var(--color-border);
            font-size: 14px;
        }

        tr:hover {
            background: var(--color-surface-hover);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-win {
            background: rgba(50, 184, 198, 0.2);
            color: var(--color-success);
        }

        .status-loss {
            background: rgba(255, 84, 89, 0.2);
            color: var(--color-error);
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }

        .progress-bar {
            height: 8px;
            background: var(--color-background);
            border-radius: 4px;
            overflow: hidden;
            margin-top: var(--space-8);
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            transition: width 0.3s;
        }

        .filters {
            display: flex;
            gap: var(--space-16);
            margin-bottom: var(--space-24);
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .rules-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
            margin-top: var(--space-16);
        }

        .rule-card {
            background: var(--color-background);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
        }

        .rule-text {
            font-size: 14px;
            margin-bottom: var(--space-8);
        }

        .rule-compliance {
            font-size: 13px;
            font-weight: 500;
        }

        .funds-table {
            margin-top: var(--space-16);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-bottom: 1px solid var(--color-border);
            }

            .main-content {
                margin-left: 0;
                padding: var(--space-16);
            }

            .app-container {
                flex-direction: column;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: var(--space-8);
            }
        }

        .auto-refresh-indicator {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-left: var(--space-8);
        }

        .auto-refresh-indicator.active {
            color: var(--color-success);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">üìä Trading Journal</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-page="dashboard">
                        <span>üè†</span> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="trades">
                        <span>üìà</span> Trades
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="funds">
                        <span>üí∞</span> Funds
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="strategies">
                        <span>üéØ</span> Strategies
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="rules">
                        <span>üìã</span> Rules
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="challenge">
                        <span>üèÜ</span> Challenge
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="settings">
                        <span>‚öôÔ∏è</span> Settings
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <!-- Dashboard Page -->
            <section id="dashboard-page" class="page-section active">
                <div class="header">
                    <h1>Dashboard</h1>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <select id="quickRefreshSelect" class="form-control" style="width: auto; padding: 8px 12px; font-size: 13px;" onchange="quickRefresh()">
                            <option value="">Quick Refresh</option>
                            <option value="5min">5 minutes</option>
                            <option value="1hr">1 hour</option>
                            <option value="1day">1 day</option>
                            <option value="manual">Manual</option>
                        </select>
                        <button class="btn btn-primary btn-small" onclick="refreshData()">üîÑ Refresh</button>
                        <span id="autoRefreshIndicator" class="auto-refresh-indicator">Auto-refresh: ON</span>
                    </div>
                </div>

                <!-- Date Range Filter -->
                <div class="card">
                    <div class="filters">
                        <div class="filter-group">
                            <label class="form-label">From Date</label>
                            <input type="date" id="filterFromDate" class="form-control">
                        </div>
                        <div class="filter-group">
                            <label class="form-label">To Date</label>
                            <input type="date" id="filterToDate" class="form-control">
                        </div>
                        <div class="filter-group" style="display: flex; align-items: flex-end; gap: 8px;">
                            <button class="btn btn-primary" onclick="applyDateFilter()">Apply Filter</button>
                            <button class="btn btn-secondary" onclick="resetDateFilter()">Reset</button>
                        </div>
                    </div>
                </div>

                <!-- Metrics Grid -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value" id="dashboardCapital">‚Çπ300,000</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Trades (This Month)</div>
                        <div class="metric-value" id="totalTrades">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="winRate">0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Cumulative P&L</div>
                        <div class="metric-value" id="cumulativePL">‚Çπ0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">ROI</div>
                        <div class="metric-value" id="roi">0%</div>
                    </div>
                </div>

                <!-- Rules Compliance Summary -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Rules Compliance</h2>
                    </div>
                    <div class="rules-summary" id="rulesCompliance"></div>
                </div>

                <!-- Recent Trades -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Trades</h2>
                        <button class="btn btn-secondary btn-small" onclick="navigateTo('trades')">View All</button>
                    </div>
                    <table id="recentTradesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Direction</th>
                                <th>P/L</th>
                                <th>Outcome</th>
                            </tr>
                        </thead>
                        <tbody id="recentTradesBody">
                            <tr><td colspan="5" class="empty-state">No trades to display</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Trades Page -->
            <section id="trades-page" class="page-section">
                <div class="header">
                    <h1>Trade History</h1>
                </div>
                <div class="card">
                    <table id="tradesTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('date')">Date <span class="sort-icon">‚ñº</span></th>
                                <th onclick="sortTable('symbol')">Symbol <span class="sort-icon">‚ñº</span></th>
                                <th onclick="sortTable('direction')">Direction <span class="sort-icon">‚ñº</span></th>
                                <th onclick="sortTable('entry')">Entry <span class="sort-icon">‚ñº</span></th>
                                <th onclick="sortTable('exit')">Exit <span class="sort-icon">‚ñº</span></th>
                                <th onclick="sortTable('pl')">P/L <span class="sort-icon">‚ñº</span></th>
                                <th onclick="sortTable('outcome')">Outcome <span class="sort-icon">‚ñº</span></th>
                                <th onclick="sortTable('strategy')">Strategy <span class="sort-icon">‚ñº</span></th>
                            </tr>
                        </thead>
                        <tbody id="tradesBody">
                            <tr><td colspan="8" class="empty-state">No trades to display</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Funds Page -->
            <section id="funds-page" class="page-section">
                <div class="header">
                    <h1>Funds Management</h1>
                    <button class="btn btn-primary" onclick="showAddFundModal()">+ Add Fund Entry</button>
                </div>

                <div class="metric-card" style="margin-bottom: 24px;">
                    <div class="metric-label">Current Capital</div>
                    <div class="metric-value" id="currentCapital">‚Çπ300,000</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Fund History</h2>
                    </div>
                    <table class="funds-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="fundsBody">
                            <tr><td colspan="3" class="empty-state">No fund entries to display</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Add Fund Modal -->
                <div id="addFundModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="card" style="width: 90%; max-width: 500px; margin: 0;">
                        <div class="card-header">
                            <h2 class="card-title">Add Fund Entry</h2>
                            <button class="btn btn-secondary btn-small" onclick="closeAddFundModal()">‚úï</button>
                        </div>
                        <form id="addFundForm" onsubmit="submitFundEntry(event)">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" id="fundDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" id="fundAmount" class="form-control" placeholder="Enter amount" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Remarks</label>
                                <select id="fundRemarks" class="form-control" required>
                                    <option value="">Select action</option>
                                    <option value="Added">Added</option>
                                    <option value="Withdrawn">Withdrawn</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Save Entry</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Strategies Page -->
            <section id="strategies-page" class="page-section">
                <div class="header">
                    <h1>Trading Strategies</h1>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Strategy Performance</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Avg P/L</th>
                                <th>Risk/Trade</th>
                            </tr>
                        </thead>
                        <tbody id="strategiesBody">
                            <tr><td colspan="5" class="empty-state">No strategy data to display</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Rules Page -->
            <section id="rules-page" class="page-section">
                <div class="header">
                    <h1>Trading Rules</h1>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Current Trading Rules</h2>
                        <button class="btn btn-secondary btn-small" onclick="refreshData()">Refresh from Sheet</button>
                    </div>
                    <div id="rulesDisplay" style="padding: 16px;">
                        <p style="color: var(--color-text-secondary); margin-bottom: 16px;">Rules are loaded from the "Rules" sheet in your Google Sheets. Update the sheet to change rules.</p>
                        <div id="rulesList"></div>
                    </div>
                </div>
            </section>

            <!-- Challenge Page -->
            <section id="challenge-page" class="page-section">
                <div class="header">
                    <h1>Capital Growth Challenge</h1>
                    <button class="btn btn-primary" onclick="showSetChallengeModal()">Set Challenge</button>
                </div>
                
                <div class="card" style="text-align: center; padding: 48px 24px;">
                    <p style="color: var(--color-text-secondary); margin-bottom: 32px;">Track your progress towards your trading goals with real-time analytics and performance metrics.</p>
                    
                    <div style="display: inline-block; position: relative; width: 200px; height: 200px; margin: 32px auto;">
                        <svg viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="90" fill="none" stroke="var(--color-background)" stroke-width="12"></circle>
                            <circle id="challengeProgressCircle" cx="100" cy="100" r="90" fill="none" stroke="var(--color-primary)" stroke-width="12" stroke-dasharray="565.48" stroke-dashoffset="0" style="transition: stroke-dashoffset 0.5s;"></circle>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <div id="challengeProgressPercent" style="font-size: 36px; font-weight: 600;">100.0%</div>
                        </div>
                    </div>
                    
                    <p style="color: var(--color-text-secondary); margin: 24px 0;">Progress to target</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-top: 48px; text-align: center;">
                        <div>
                            <div style="color: var(--color-text-secondary); font-size: 13px; margin-bottom: 8px;">Starting</div>
                            <div id="challengeStarting" style="font-size: 24px; font-weight: 600;">‚Çπ50,000</div>
                        </div>
                        <div>
                            <div style="color: var(--color-text-secondary); font-size: 13px; margin-bottom: 8px;">Current</div>
                            <div id="challengeCurrentDisplay" style="font-size: 24px; font-weight: 600; color: var(--color-primary);">‚Çπ133750.00</div>
                        </div>
                        <div>
                            <div style="color: var(--color-text-secondary); font-size: 13px; margin-bottom: 8px;">Target</div>
                            <div id="challengeTargetDisplay" style="font-size: 24px; font-weight: 600;">‚Çπ100,000</div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid var(--color-border); margin-top: 48px; padding-top: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <span style="color: var(--color-text-secondary);">Daily Target</span>
                            <span id="challengeDailyTarget" style="font-size: 18px; font-weight: 600;">‚Çπ-562.50/day</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);">Days Remaining</span>
                            <span id="challengeDaysRemaining" style="font-size: 18px; font-weight: 600;">60</span>
                        </div>
                        <div class="progress-bar" style="margin-top: 16px;">
                            <div class="progress-fill" id="challengeTimeProgressBar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Set Challenge Modal -->
                <div id="setChallengeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="card" style="width: 90%; max-width: 500px; margin: 0;">
                        <div class="card-header">
                            <h2 class="card-title">Set Capital Challenge</h2>
                            <button class="btn btn-secondary btn-small" onclick="closeSetChallengeModal()">‚úï</button>
                        </div>
                        <form id="setChallengeForm" onsubmit="submitChallenge(event)">
                            <div class="form-group">
                                <label class="form-label">Starting Capital</label>
                                <input type="number" id="challengeStartingInput" class="form-control" placeholder="Enter starting capital" value="50000" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Target Capital</label>
                                <input type="number" id="challengeTargetInput" class="form-control" placeholder="Enter target capital" value="100000" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time Period (Days)</label>
                                <input type="number" id="challengeDaysInput" class="form-control" placeholder="Enter number of days" value="60" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" id="challengeStartDate" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Save Challenge</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Settings Page -->
            <section id="settings-page" class="page-section">
                <div class="header">
                    <h1>Settings</h1>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Google Sheets Integration</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Google Apps Script URL</label>
                        <input type="url" id="sheetUrl" class="form-control" placeholder="https://script.google.com/macros/s/..." value="https://script.google.com/macros/s/AKfycbxk0zuUSff4150jrZ4S5UR0ZnN9FCHwQOGCrvz7R57Pq3nObekYYROy4YZ2vFfeOdUC/exec">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    <div id="connectionStatus" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
                    <p style="margin-top: 16px; color: var(--color-text-secondary); font-size: 13px;">
                        Required Sheets: "Trades", "Funds", "Strategies", "Rules"<br>
                        Trades columns: Date, Symbol, Direction, Entry, Exit, SL, Quantity, Strategy, Outcome, Remarks<br>
                        Funds columns: Date, Amount, Remarks<br>
                        Strategies: Strategy names (one per row)<br>
                        Rules: Rule text (one per row)
                    </p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Capital Settings</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Initial Capital</label>
                        <input type="number" id="initialCapital" class="form-control" placeholder="Enter initial capital" value="300000">
                    </div>
                    <button class="btn btn-primary" onclick="saveCapital()">Save Capital</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Auto-Refresh Settings</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Auto-refresh interval (minutes)</label>
                        <select id="autoRefreshInterval" class="form-control" onchange="updateAutoRefresh()">
                            <option value="0">Disabled</option>
                            <option value="1">1 minute</option>
                            <option value="2">2 minutes</option>
                            <option value="5" selected>5 minutes</option>
                            <option value="10">10 minutes</option>
                        </select>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Global state
        let appState = {
            trades: [],
            funds: [],
            strategies: [],
            rules: [],
            filteredTrades: [],
            sheetUrl: localStorage.getItem('sheetUrl') || 'https://script.google.com/macros/s/AKfycbxk0zuUSff4150jrZ4S5UR0ZnN9FCHwQOGCrvz7R57Pq3nObekYYROy4YZ2vFfeOdUC/exec',
            initialCapital: 300000,
            currentCapital: 300000,
            autoRefreshInterval: 5,
            autoRefreshTimer: null,
            sortColumn: null,
            sortDirection: 'asc'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            setupNavigation();
            setDefaultDateFilter();
            refreshData();
            setupAutoRefresh();
        });

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    navigateTo(page);
                });
            });
        }

        function navigateTo(page) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            document.getElementById(`${page}-page`).classList.add('active');
        }

        // Date filter functions
        function setDefaultDateFilter() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('filterFromDate').valueAsDate = firstDay;
            document.getElementById('filterToDate').valueAsDate = lastDay;
        }

        function applyDateFilter() {
            const fromDate = new Date(document.getElementById('filterFromDate').value);
            const toDate = new Date(document.getElementById('filterToDate').value);
            
            appState.filteredTrades = appState.trades.filter(trade => {
                const tradeDate = new Date(trade.date);
                return tradeDate >= fromDate && tradeDate <= toDate;
            });
            
            updateDashboard();
            updateRecentTrades();
        }

        function resetDateFilter() {
            setDefaultDateFilter();
            applyDateFilter();
        }

        // Data loading
        async function refreshData() {
            if (!appState.sheetUrl) {
                console.error('No sheet URL configured');
                return;
            }

            try {
                const response = await fetch(appState.sheetUrl);
                const data = await response.json();
                
                appState.trades = data.Trades || [];
                appState.funds = data.Funds || [];
                appState.strategies = data.Strategies || [];
                appState.rules = data.Rules || [];
                
                // Calculate current capital from funds
                calculateCurrentCapital();
                
                // Apply current filter
                applyDateFilter();
                
                // Update all views
                updateAllViews();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function calculateCurrentCapital() {
            let capital = appState.initialCapital;
            
            // Add/subtract funds
            appState.funds.forEach(fund => {
                if (fund.remarks === 'Added') {
                    capital += parseFloat(fund.amount) || 0;
                } else if (fund.remarks === 'Withdrawn') {
                    capital -= parseFloat(fund.amount) || 0;
                }
            });
            
            // Add cumulative P&L from trades
            appState.trades.forEach(trade => {
                const pl = parseFloat(trade.pl) || 0;
                capital += pl;
            });
            
            appState.currentCapital = capital;
        }

        function updateAllViews() {
            updateDashboard();
            updateTradesTable();
            updateFundsTable();
            updateStrategiesTable();
            updateRulesDisplay();
            updateRulesCompliance();
            updateChallenge();
        }

        // Dashboard updates
        function updateDashboard() {
            const trades = appState.filteredTrades;
            
            // Update capital display
            document.getElementById('dashboardCapital').textContent = '‚Çπ' + appState.currentCapital.toLocaleString();
            
            // Total trades this month (using filtered trades)
            document.getElementById('totalTrades').textContent = trades.length;
            
            // Win rate
            const wins = trades.filter(t => (t.outcome || '').toLowerCase() === 'win').length;
            const winRate = trades.length > 0 ? ((wins / trades.length) * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = winRate + '%';
            
            // Cumulative P&L
            const cumulativePL = trades.reduce((sum, t) => sum + (parseFloat(t.pl) || 0), 0);
            document.getElementById('cumulativePL').textContent = '‚Çπ' + cumulativePL.toLocaleString();
            document.getElementById('cumulativePL').className = 'metric-value ' + (cumulativePL >= 0 ? 'positive' : 'negative');
            
            // ROI based on capital
            const roi = appState.initialCapital > 0 ? ((cumulativePL / appState.initialCapital) * 100).toFixed(2) : 0;
            document.getElementById('roi').textContent = roi + '%';
            document.getElementById('roi').className = 'metric-value ' + (roi >= 0 ? 'positive' : 'negative');
        }

        function updateRecentTrades() {
            const tbody = document.getElementById('recentTradesBody');
            const trades = appState.filteredTrades.slice(0, 5);
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No trades to display</td></tr>';
                return;
            }
            
            tbody.innerHTML = trades.map(trade => `
                <tr>
                    <td>${formatDate(trade.date)}</td>
                    <td>${trade.symbol}</td>
                    <td>${trade.direction}</td>
                    <td class="${parseFloat(trade.pl) >= 0 ? 'positive' : 'negative'}">‚Çπ${parseFloat(trade.pl || 0).toLocaleString()}</td>
                    <td><span class="status-badge status-${(trade.outcome || '').toLowerCase()}">${trade.outcome}</span></td>
                </tr>
            `).join('');
        }

        // Trades table
        function updateTradesTable() {
            const tbody = document.getElementById('tradesBody');
            const trades = appState.trades;
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No trades to display</td></tr>';
                return;
            }
            
            tbody.innerHTML = trades.map(trade => `
                <tr>
                    <td>${formatDate(trade.date)}</td>
                    <td>${trade.symbol}</td>
                    <td>${trade.direction}</td>
                    <td>‚Çπ${parseFloat(trade.entry || 0).toLocaleString()}</td>
                    <td>‚Çπ${parseFloat(trade.exit || 0).toLocaleString()}</td>
                    <td class="${parseFloat(trade.pl) >= 0 ? 'positive' : 'negative'}">‚Çπ${parseFloat(trade.pl || 0).toLocaleString()}</td>
                    <td><span class="status-badge status-${(trade.outcome || '').toLowerCase()}">${trade.outcome}</span></td>
                    <td>${trade.strategy}</td>
                </tr>
            `).join('');
        }

        // Sorting function
        function sortTable(column) {
            if (appState.sortColumn === column) {
                appState.sortDirection = appState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                appState.sortColumn = column;
                appState.sortDirection = 'asc';
            }
            
            appState.trades.sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 'date':
                        valA = new Date(a.date);
                        valB = new Date(b.date);
                        break;
                    case 'entry':
                    case 'exit':
                    case 'pl':
                        valA = parseFloat(a[column]) || 0;
                        valB = parseFloat(b[column]) || 0;
                        break;
                    default:
                        valA = (a[column] || '').toString().toLowerCase();
                        valB = (b[column] || '').toString().toLowerCase();
                }
                
                if (valA < valB) return appState.sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return appState.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Update sort indicators
            document.querySelectorAll('#tradesTable th').forEach(th => th.classList.remove('sorted'));
            document.querySelector(`#tradesTable th[onclick="sortTable('${column}')"]`).classList.add('sorted');
            
            updateTradesTable();
        }

        // Funds management
        function updateFundsTable() {
            const tbody = document.getElementById('fundsBody');
            const funds = appState.funds;
            
            document.getElementById('currentCapital').textContent = '‚Çπ' + appState.currentCapital.toLocaleString();
            
            if (funds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No fund entries to display</td></tr>';
                return;
            }
            
            tbody.innerHTML = funds.map(fund => `
                <tr>
                    <td>${formatDate(fund.date)}</td>
                    <td class="${fund.remarks === 'Added' ? 'positive' : 'negative'}">‚Çπ${parseFloat(fund.amount || 0).toLocaleString()}</td>
                    <td>${fund.remarks}</td>
                </tr>
            `).join('');
        }

        function showAddFundModal() {
            document.getElementById('addFundModal').style.display = 'flex';
            document.getElementById('fundDate').valueAsDate = new Date();
        }

        function closeAddFundModal() {
            document.getElementById('addFundModal').style.display = 'none';
            document.getElementById('addFundForm').reset();
        }

        async function submitFundEntry(event) {
            event.preventDefault();
            
            const fundData = {
                date: document.getElementById('fundDate').value,
                amount: document.getElementById('fundAmount').value,
                remarks: document.getElementById('fundRemarks').value
            };
            
            // Note: You'll need to implement the Google Sheets API write functionality
            alert('Fund entry saved. (Note: Implement Google Sheets write API to persist data)');
            
            closeAddFundModal();
        }

        // Strategies
        function updateStrategiesTable() {
            const tbody = document.getElementById('strategiesBody');
            
            // Get unique strategies from trades
            const strategyMap = {};
            
            appState.trades.forEach(trade => {
                const strategy = trade.strategy || 'Unknown';
                if (!strategyMap[strategy]) {
                    strategyMap[strategy] = {
                        trades: [],
                        totalRisk: 0
                    };
                }
                strategyMap[strategy].trades.push(trade);
                
                // Calculate risk per trade
                const entry = parseFloat(trade.entry) || 0;
                const sl = parseFloat(trade.sl) || 0;
                const qty = parseFloat(trade.quantity) || 1;
                const risk = Math.abs(entry - sl) * qty;
                strategyMap[strategy].totalRisk += risk;
            });
            
            const strategies = Object.keys(strategyMap);
            
            if (strategies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No strategy data to display</td></tr>';
                return;
            }
            
            tbody.innerHTML = strategies.map(strategy => {
                const data = strategyMap[strategy];
                const trades = data.trades;
                const wins = trades.filter(t => (t.outcome || '').toLowerCase() === 'win').length;
                const winRate = ((wins / trades.length) * 100).toFixed(1);
                const avgPL = trades.reduce((sum, t) => sum + (parseFloat(t.pl) || 0), 0) / trades.length;
                const avgRisk = data.totalRisk / trades.length;
                
                return `
                    <tr>
                        <td>${strategy}</td>
                        <td>${trades.length}</td>
                        <td>${winRate}%</td>
                        <td class="${avgPL >= 0 ? 'positive' : 'negative'}">‚Çπ${avgPL.toFixed(2)}</td>
                        <td>‚Çπ${avgRisk.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Rules
        function updateRulesDisplay() {
            const rulesList = document.getElementById('rulesList');
            
            if (appState.rules.length === 0) {
                rulesList.innerHTML = '<p class="empty-state">No rules configured. Add rules to the "Rules" sheet.</p>';
                return;
            }
            
            rulesList.innerHTML = appState.rules.map((rule, index) => `
                <div class="rule-card">
                    <div class="rule-text">${index + 1}. ${rule.rule || rule}</div>
                </div>
            `).join('');
        }

        function updateRulesCompliance() {
            const container = document.getElementById('rulesCompliance');
            const trades = appState.filteredTrades;
            
            if (trades.length === 0) {
                container.innerHTML = '<p class="empty-state">No trades in selected period</p>';
                return;
            }
            
            // Define rule checks
            const ruleChecks = [
                {
                    name: 'Only one lot in Nifty',
                    check: () => {
                        const niftyTrades = trades.filter(t => (t.symbol || '').toLowerCase().includes('nifty'));
                        const violations = niftyTrades.filter(t => parseFloat(t.quantity) > 1);
                        return { compliant: niftyTrades.length - violations.length, total: niftyTrades.length };
                    }
                },
                {
                    name: 'Two lots in Sensex',
                    check: () => {
                        const sensexTrades = trades.filter(t => (t.symbol || '').toLowerCase().includes('sensex'));
                        const compliant = sensexTrades.filter(t => parseFloat(t.quantity) === 2);
                        return { compliant: compliant.length, total: sensexTrades.length };
                    }
                },
                {
                    name: 'Max 3 trades per day',
                    check: () => {
                        const tradesByDate = {};
                        trades.forEach(t => {
                            const date = t.date;
                            tradesByDate[date] = (tradesByDate[date] || 0) + 1;
                        });
                        const days = Object.keys(tradesByDate);
                        const compliantDays = days.filter(d => tradesByDate[d] <= 3).length;
                        return { compliant: compliantDays, total: days.length };
                    }
                },
                {
                    name: 'Min 1:2 Risk/Reward',
                    check: () => {
                        const tradesWithRR = trades.filter(t => {
                            const entry = parseFloat(t.entry) || 0;
                            const exit = parseFloat(t.exit) || 0;
                            const sl = parseFloat(t.sl) || 0;
                            if (entry && exit && sl) {
                                const risk = Math.abs(entry - sl);
                                const reward = Math.abs(exit - entry);
                                return reward >= risk * 2;
                            }
                            return false;
                        });
                        return { compliant: tradesWithRR.length, total: trades.length };
                    }
                },
                {
                    name: 'Max loss ‚Çπ1000-2000',
                    check: () => {
                        const compliantTrades = trades.filter(t => {
                            const pl = parseFloat(t.pl) || 0;
                            return pl >= -2000;
                        });
                        return { compliant: compliantTrades.length, total: trades.length };
                    }
                }
            ];
            
            container.innerHTML = ruleChecks.map(rule => {
                const result = rule.check();
                const percentage = result.total > 0 ? ((result.compliant / result.total) * 100).toFixed(0) : 0;
                
                return `
                    <div class="rule-card">
                        <div class="rule-text">${rule.name}</div>
                        <div class="rule-compliance ${percentage >= 80 ? 'positive' : 'negative'}">
                            ${result.compliant} / ${result.total} trades (${percentage}%)
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Challenge
        function updateChallenge() {
            const challengeData = JSON.parse(localStorage.getItem('challengeData') || '{"starting": 50000, "target": 100000, "days": 60, "startDate": "2025-09-01"}');
            const current = appState.currentCapital;
            
            document.getElementById('challengeStarting').textContent = '‚Çπ' + challengeData.starting.toLocaleString();
            document.getElementById('challengeTargetDisplay').textContent = '‚Çπ' + challengeData.target.toLocaleString();
            document.getElementById('challengeCurrentDisplay').textContent = '‚Çπ' + current.toLocaleString();
            
            // Calculate progress percentage
            const progress = ((current - challengeData.starting) / (challengeData.target - challengeData.starting) * 100).toFixed(1);
            document.getElementById('challengeProgressPercent').textContent = Math.max(0, progress) + '%';
            
            // Update circular progress bar
            const circumference = 2 * Math.PI * 90; // 565.48
            const offset = circumference - (Math.min(100, Math.max(0, progress)) / 100 * circumference);
            document.getElementById('challengeProgressCircle').style.strokeDashoffset = offset;
            
            // Calculate days elapsed and remaining
            const startDate = new Date(challengeData.startDate);
            const today = new Date();
            const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const daysRemaining = Math.max(0, challengeData.days - daysElapsed);
            
            document.getElementById('challengeDaysRemaining').textContent = daysRemaining;
            
            // Calculate daily target (remaining amount / remaining days)
            const remainingAmount = challengeData.target - current;
            const dailyTarget = daysRemaining > 0 ? remainingAmount / daysRemaining : 0;
            document.getElementById('challengeDailyTarget').textContent = '‚Çπ' + dailyTarget.toFixed(2) + '/day';
            
            // Update time progress bar
            const timeProgress = (daysElapsed / challengeData.days * 100);
            document.getElementById('challengeTimeProgressBar').style.width = Math.min(100, timeProgress) + '%';
        }

        function showSetChallengeModal() {
            const challengeData = JSON.parse(localStorage.getItem('challengeData') || '{"starting": 50000, "target": 100000, "days": 60, "startDate": "2025-09-01"}');
            document.getElementById('challengeStartingInput').value = challengeData.starting;
            document.getElementById('challengeTargetInput').value = challengeData.target;
            document.getElementById('challengeDaysInput').value = challengeData.days;
            document.getElementById('challengeStartDate').value = challengeData.startDate;
            document.getElementById('setChallengeModal').style.display = 'flex';
        }

        function closeSetChallengeModal() {
            document.getElementById('setChallengeModal').style.display = 'none';
        }

        function submitChallenge(event) {
            event.preventDefault();
            
            const challengeData = {
                starting: parseFloat(document.getElementById('challengeStartingInput').value),
                target: parseFloat(document.getElementById('challengeTargetInput').value),
                days: parseInt(document.getElementById('challengeDaysInput').value),
                startDate: document.getElementById('challengeStartDate').value
            };
            
            localStorage.setItem('challengeData', JSON.stringify(challengeData));
            closeSetChallengeModal();
            updateChallenge();
            alert('Challenge settings saved!');
        }

        // Settings
        function loadSettings() {
            const savedUrl = localStorage.getItem('sheetUrl');
            const savedCapital = localStorage.getItem('initialCapital');
            const savedInterval = localStorage.getItem('autoRefreshInterval');
            
            if (savedUrl) {
                appState.sheetUrl = savedUrl;
                document.getElementById('sheetUrl').value = savedUrl;
            }
            
            if (savedCapital) {
                appState.initialCapital = parseFloat(savedCapital);
                document.getElementById('initialCapital').value = savedCapital;
            }
            
            if (savedInterval) {
                appState.autoRefreshInterval = parseInt(savedInterval);
                document.getElementById('autoRefreshInterval').value = savedInterval;
            }
        }

        function saveSettings() {
            const url = document.getElementById('sheetUrl').value;
            appState.sheetUrl = url;
            localStorage.setItem('sheetUrl', url);
            
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(50, 184, 198, 0.2)';
            statusDiv.style.color = 'var(--color-success)';
            statusDiv.innerHTML = '‚úì Connected to Google Sheets<br><small style="opacity: 0.8;">URL saved successfully. Refreshing data...</small>';
            
            refreshData();
        }

        function saveCapital() {
            const capital = document.getElementById('initialCapital').value;
            appState.initialCapital = parseFloat(capital);
            localStorage.setItem('initialCapital', capital);
            alert('Capital saved!');
            calculateCurrentCapital();
            updateAllViews();
        }

        function updateAutoRefresh() {
            const interval = parseInt(document.getElementById('autoRefreshInterval').value);
            appState.autoRefreshInterval = interval;
            localStorage.setItem('autoRefreshInterval', interval);
            setupAutoRefresh();
        }

        function setupAutoRefresh() {
            // Clear existing timer
            if (appState.autoRefreshTimer) {
                clearInterval(appState.autoRefreshTimer);
            }
            
            const indicator = document.getElementById('autoRefreshIndicator');
            
            if (appState.autoRefreshInterval > 0) {
                indicator.textContent = `Auto-refresh: ON (${appState.autoRefreshInterval}m)`;
                indicator.classList.add('active');
                
                // Set up new timer
                appState.autoRefreshTimer = setInterval(() => {
                    refreshData();
                }, appState.autoRefreshInterval * 60 * 1000);
            } else {
                indicator.textContent = 'Auto-refresh: OFF';
                indicator.classList.remove('active');
            }
        }

        function quickRefresh() {
            const select = document.getElementById('quickRefreshSelect');
            const value = select.value;
            
            if (value === 'manual') {
                refreshData();
                select.value = '';
                return;
            }
            
            // Convert to minutes
            let minutes = 0;
            switch(value) {
                case '5min':
                    minutes = 5;
                    break;
                case '1hr':
                    minutes = 60;
                    break;
                case '1day':
                    minutes = 1440;
                    break;
            }
            
            if (minutes > 0) {
                appState.autoRefreshInterval = minutes;
                document.getElementById('autoRefreshInterval').value = minutes;
                localStorage.setItem('autoRefreshInterval', minutes);
                setupAutoRefresh();
                refreshData();
            }
            
            select.value = '';
        }

        // Utility functions
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }
    </script>
</body>
</html>
